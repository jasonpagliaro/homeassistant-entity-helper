name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Ruff lint
        run: make lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Mypy typecheck
        run: make typecheck

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Pytest
        run: make test

  lxc-assets:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, tests]
    steps:
      - uses: actions/checkout@v4
      - name: Validate LXC scripts syntax
        run: |
          bash -n lxc/create-lxc-container.sh
          bash -n lxc/setup-in-container.sh
          bash -n lxc/update-host.sh
          bash -n lxc/update-in-container.sh
      - name: Verify systemd unit exists
        run: test -f lxc/ha-entity-vault.service
      - name: Verify update assets exist
        run: |
          test -f lxc/ha-entity-vault-update.env.example
          test -f lxc/ha-entity-vault-update-check.service
          test -f lxc/ha-entity-vault-update-check.timer
