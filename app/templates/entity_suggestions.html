{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Entity Suggestions</h2>

  <form method="get" action="/entity-suggestions" class="grid-form compact">
    <label>
      Profile
      <select name="profile_id" onchange="this.form.submit()">
        {% for profile in profiles %}
          <option value="{{ profile.id }}" {% if active_profile and profile.id == active_profile.id %}selected{% endif %}>{{ profile.name }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Suggestion Run
      <select name="suggestion_run_id">
        <option value="">Latest</option>
        {% for run in suggestion_runs %}
          <option value="{{ run.id }}" {% if active_suggestion_run and run.id == active_suggestion_run.id %}selected{% endif %}>#{{ run.id }} ({{ run.pulled_at }}, {{ run.status }})</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Search
      <input type="text" name="q" value="{{ q }}" placeholder="entity/issue/missing..." />
    </label>

    <label>
      Readiness
      <select name="status">
        <option value="">All</option>
        {% for item in statuses %}
          <option value="{{ item }}" {% if item == status %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Domain
      <select name="domain">
        <option value="">All</option>
        {% for item in domains %}
          <option value="{{ item }}" {% if item == domain %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Page Size
      <input type="number" name="page_size" min="1" max="200" value="{{ page_size }}" />
    </label>

    <div class="row gap-sm align-end">
      <button type="submit">Apply Filters</button>
      <a class="button" href="/entity-suggestions?{{ build_query(profile_id=active_profile.id if active_profile else None) }}">Reset</a>
    </div>
  </form>

  <div class="row between wrap gap-sm">
    <div>
      {% if active_profile %}
        <strong>Active Profile:</strong> {{ active_profile.name }}
      {% endif %}
      {% if active_suggestion_run %}
        <div><strong>Run:</strong> #{{ active_suggestion_run.id }} ({{ active_suggestion_run.status }})</div>
        <div><strong>Run Summary (run-wide):</strong> {{ active_suggestion_run.ready_count }} ready / {{ active_suggestion_run.needs_review_count }} needs review / {{ active_suggestion_run.blocked_count }} blocked</div>
        <div><strong>Candidate Scope:</strong> {{ suggestion_scope_domains_text }}</div>
        {% if run_area_check_degraded %}
          <div><strong>Run Note:</strong> Area checks were downgraded for this run because no area/device enrichment was available during scoring.</div>
        {% endif %}
      {% endif %}
    </div>

    {% if active_profile %}
      <div class="row gap-sm wrap">
        <a class="button" href="/entity-suggestions/workflow?{{ build_query(profile_id=active_profile.id, suggestion_run_id=active_suggestion_run.id if active_suggestion_run else None) }}">Resolve Missing Details</a>
        <form
          method="post"
          action="/profiles/{{ active_profile.id }}/run-entity-suggestions"
          data-sync-modal="true"
          data-sync-modal-label="Running entity suggestions..."
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          <input type="hidden" name="next_url" value="{{ next_url }}" />
          <button type="submit">Run Suggestions Check</button>
        </form>
        {% if active_suggestion_run %}
          <form
            method="post"
            action="/profiles/{{ active_profile.id }}/generate-automation-drafts"
            data-sync-modal="true"
            data-sync-modal-label="Generating automation drafts..."
          >
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <input type="hidden" name="suggestion_run_id" value="{{ active_suggestion_run.id }}" />
            <input type="hidden" name="readiness_status" value="ready" />
            <input type="hidden" name="next_url" value="/automation-drafts?{{ build_query(profile_id=active_profile.id) }}" />
            <button type="submit">Generate Drafts (Ready)</button>
          </form>
        {% endif %}
      </div>
    {% endif %}
  </div>

  {% if active_profile and active_suggestion_run %}
    <p>{{ total }} suggestions match filters.</p>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Entity ID</th>
            <th>Domain</th>
            <th>Readiness</th>
            <th>Workflow</th>
            <th>Missing Fields</th>
            <th>Pulled At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in suggestions %}
          <tr>
            <td>{{ item.id }}</td>
            <td><code>{{ item.entity_id }}</code></td>
            <td>{{ item.domain }}</td>
            <td><span class="status-chip status-{{ item.readiness_status }}">{{ item.readiness_status }}</span></td>
            <td><span class="status-chip status-{{ item.workflow_status }}">{{ item.workflow_status }}</span></td>
            <td>{{ item.missing_fields_json or '[]' }}</td>
            <td>{{ item.pulled_at }}</td>
            <td>
              <a href="/entity-suggestions/{{ item.id }}?{{ build_query(profile_id=active_profile.id, suggestion_run_id=active_suggestion_run.id) }}">Details</a>
              <span> | </span>
              <a href="/entity-suggestions/{{ item.id }}/workflow?{{ build_query(profile_id=active_profile.id, suggestion_run_id=active_suggestion_run.id) }}">Fix</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row between">
      <div>Page {{ page }} of {{ total_pages }}</div>
      <div class="row gap-sm">
        {% if page > 1 %}
          <a class="button" href="/entity-suggestions?{{ build_query(profile_id=active_profile.id, suggestion_run_id=active_suggestion_run.id, q=q, status=status, domain=domain, page=page-1, page_size=page_size) }}">Previous</a>
        {% endif %}
        {% if page < total_pages %}
          <a class="button" href="/entity-suggestions?{{ build_query(profile_id=active_profile.id, suggestion_run_id=active_suggestion_run.id, q=q, status=status, domain=domain, page=page+1, page_size=page_size) }}">Next</a>
        {% endif %}
      </div>
    </div>
  {% elif active_profile %}
    <p>No suggestion run results for this profile yet.</p>
  {% else %}
    <p>No profiles found. Create one on the settings page.</p>
  {% endif %}
</section>
{% endblock %}
