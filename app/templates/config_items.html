{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Config Items</h2>

  <form method="get" action="/config-items" class="grid-form compact">
    {% if active_profile %}
      <input type="hidden" name="profile_id" value="{{ active_profile.id }}" />
    {% endif %}

    <label>
      Sync Run
      <select name="config_sync_run_id">
        <option value="">Latest</option>
        {% for run in config_runs %}
          <option value="{{ run.id }}" {% if active_config_sync_run and run.id == active_config_sync_run.id %}selected{% endif %}>#{{ run.id }} ({{ run.pulled_at }}, {{ run.status }})</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Search
      <input type="text" name="q" value="{{ q }}" placeholder="entity/name/key/error..." />
    </label>

    <label>
      Kind
      <select name="kind">
        <option value="">All</option>
        {% for item in kinds %}
          <option value="{{ item }}" {% if item == kind %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Fetch Status
      <select name="status">
        <option value="">All</option>
        {% for item in statuses %}
          <option value="{{ item }}" {% if item == status %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Page Size
      <input type="number" name="page_size" min="1" max="200" value="{{ page_size }}" />
    </label>

    <div class="row gap-sm align-end">
      <button type="submit">Apply Filters</button>
      <a class="button" href="/config-items?{{ build_query(profile_id=active_profile.id if active_profile else None) }}">Reset</a>
    </div>
  </form>

  <div class="row between wrap gap-sm">
    <div>
      {% if active_profile %}
        <strong>Active Profile:</strong> {{ active_profile.name }}
      {% endif %}
      {% if active_config_sync_run %}
        <div><strong>Last Config Sync:</strong> {{ active_config_sync_run.pulled_at }}</div>
        <div><strong>Status:</strong> {{ active_config_sync_run.status }} ({{ active_config_sync_run.success_count }} success / {{ active_config_sync_run.error_count }} errors)</div>
      {% endif %}
    </div>

    {% if active_profile %}
      <div class="row gap-sm wrap">
        <form
          method="post"
          action="/profiles/{{ active_profile.id }}/sync-config"
          data-sync-modal="true"
          data-sync-modal-label="Syncing config items..."
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          <input type="hidden" name="next_url" value="{{ next_url }}" />
          <button type="submit">Sync Config Items</button>
        </form>
        {% if active_llm_connection and active_config_sync_run %}
          <form
            method="post"
            action="/profiles/{{ active_profile.id }}/suggestions/runs"
            data-sync-modal="true"
            data-sync-modal-label="Queueing automation suggestions..."
          >
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <input type="hidden" name="next_url" value="/suggestions?{{ build_query(profile_id=active_profile.id) }}" />
            <input type="hidden" name="llm_connection_id" value="{{ active_llm_connection.id }}" />
            <input type="hidden" name="config_sync_run_id" value="{{ active_config_sync_run.id }}" />
            <input type="hidden" name="q" value="{{ q }}" />
            <input type="hidden" name="max_targets" value="25" />
            <button type="submit">Suggest Automation Updates</button>
          </form>
        {% endif %}
        <a class="button" href="/suggestions?{{ build_query(profile_id=active_profile.id) }}">View Automation Suggestions</a>
        <a class="button" href="/entity-suggestions?{{ build_query(profile_id=active_profile.id) }}">View Entity Suggestions</a>
      </div>
    {% endif %}
  </div>

  {% if active_profile and not active_llm_connection %}
    <p>No enabled LLM connection for this profile. Configure one on the <a href="/settings?{{ build_query(profile_id=active_profile.id) }}">Profiles page</a>.</p>
  {% endif %}

  {% if active_profile and active_config_sync_run %}
    <p>{{ total }} config items match filters.</p>
    <div class="table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Kind</th>
            <th>Entity ID</th>
            <th>Name</th>
            <th>Config Key</th>
            <th>Status</th>
            <th>Pulled At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in config_items %}
          <tr>
            <td data-label="ID">{{ item.id }}</td>
            <td data-label="Kind">{{ item.kind }}</td>
            <td data-label="Entity ID"><code>{{ item.entity_id }}</code></td>
            <td data-label="Name">{{ item.name or '' }}</td>
            <td data-label="Config Key"><code>{{ item.config_key or '' }}</code></td>
            <td data-label="Status"><span class="status-chip status-{{ item.fetch_status }}">{{ item.fetch_status }}</span></td>
            <td data-label="Pulled At">{{ item.pulled_at }}</td>
            <td data-label="Actions">
              <a href="/config-items/{{ item.id }}?{{ build_query(profile_id=active_profile.id, config_sync_run_id=active_config_sync_run.id) }}">Details</a>
              {% if active_llm_connection and item.kind == "automation" and item.fetch_status == "success" %}
                <form
                  method="post"
                  action="/profiles/{{ active_profile.id }}/suggestions/runs"
                  class="inline-form"
                  data-sync-modal="true"
                  data-sync-modal-label="Queueing automation suggestion..."
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <input type="hidden" name="next_url" value="/suggestions?{{ build_query(profile_id=active_profile.id) }}" />
                  <input type="hidden" name="llm_connection_id" value="{{ active_llm_connection.id }}" />
                  <input type="hidden" name="snapshot_id" value="{{ item.id }}" />
                  <button type="submit">Suggest</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row between">
      <div>Page {{ page }} of {{ total_pages }}</div>
      <div class="row gap-sm">
        {% if page > 1 %}
          <a class="button" href="/config-items?{{ build_query(profile_id=active_profile.id, config_sync_run_id=active_config_sync_run.id, q=q, kind=kind, status=status, page=page-1, page_size=page_size) }}">Previous</a>
        {% endif %}
        {% if page < total_pages %}
          <a class="button" href="/config-items?{{ build_query(profile_id=active_profile.id, config_sync_run_id=active_config_sync_run.id, q=q, kind=kind, status=status, page=page+1, page_size=page_size) }}">Next</a>
        {% endif %}
      </div>
    </div>
  {% elif active_profile %}
    <p>No synced config items for this profile yet. Use <strong>Sync Config Items</strong>.</p>
  {% elif profile_count > 0 %}
    <p>No enabled profiles are available. Enable a profile on the <a href="/settings">Profiles page</a>.</p>
  {% else %}
    <p>No profiles are configured yet. Add one on the <a href="/settings">Profiles page</a>.</p>
    <p>
      Need help? See
      <a href="https://www.home-assistant.io/docs/configuration/" target="_blank" rel="noreferrer">Home Assistant configuration</a>
      and
      <a href="https://developers.home-assistant.io/docs/auth_api/#long-lived-access-token" target="_blank" rel="noreferrer">token setup</a>.
    </p>
  {% endif %}
</section>
{% endblock %}
