{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Entities</h2>

  <form method="get" action="/entities" class="grid-form compact">
    {% if active_profile %}
      <input type="hidden" name="profile_id" value="{{ active_profile.id }}" />
    {% endif %}

    {% if active_sync_run %}
      <input type="hidden" name="sync_run_id" value="{{ active_sync_run.id }}" />
    {% endif %}

    <label>
      Search
      <input type="text" name="q" value="{{ q }}" placeholder="entity/name/area/location..." />
    </label>

    <label>
      Domain
      <select name="domain">
        <option value="">All</option>
        {% for item in domains %}
          <option value="{{ item }}" {% if item == domain %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      State
      <select name="state">
        <option value="">All</option>
        {% for item in states %}
          <option value="{{ item }}" {% if item == state_value %}selected{% endif %}>{{ item }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Changed Within (minutes)
      <input type="number" name="changed_within" min="1" value="{{ changed_within or '' }}" />
    </label>

    <label>
      Page Size
      <input type="number" name="page_size" min="1" max="200" value="{{ page_size }}" />
    </label>

    <div class="row gap-sm align-end">
      <button type="submit">Apply Filters</button>
      <a class="button" href="/entities?{{ build_query(profile_id=active_profile.id if active_profile else None) }}">Reset</a>
    </div>
  </form>

  <div class="row between wrap gap-sm">
    <div>
      {% if active_profile %}
        <strong>Active Profile:</strong> {{ active_profile.name }}
      {% endif %}
      {% if active_sync_run %}
        <div><strong>Last Sync:</strong> {{ active_sync_run.pulled_at }}</div>
      {% endif %}
    </div>

    {% if active_profile %}
    <div class="row gap-sm wrap">
      <form
        method="post"
        action="/profiles/{{ active_profile.id }}/sync"
        data-sync-modal="true"
        data-sync-modal-label="Syncing entities..."
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <input type="hidden" name="next_url" value="{{ next_url }}" />
        <button type="submit">Sync Now</button>
      </form>
      <form
        method="post"
        action="/profiles/{{ active_profile.id }}/sync-config"
        data-sync-modal="true"
        data-sync-modal-label="Syncing config items..."
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <input type="hidden" name="next_url" value="/config-items?{{ build_query(profile_id=active_profile.id) }}" />
        <button type="submit">Sync Config Items</button>
      </form>
      <a class="button" href="/config-items?{{ build_query(profile_id=active_profile.id) }}">View Config Items</a>

      {% if active_sync_run %}
        <a class="button" href="/export/json?{{ build_query(profile_id=active_profile.id, sync_run_id=active_sync_run.id, q=q, domain=domain, state=state_value, changed_within=changed_within) }}">Export JSON</a>
        <a class="button" href="/export/csv?{{ build_query(profile_id=active_profile.id, sync_run_id=active_sync_run.id, q=q, domain=domain, state=state_value, changed_within=changed_within) }}">Export CSV</a>
      {% endif %}
    </div>
    {% endif %}
  </div>

  {% if active_profile and active_sync_run %}
    <p>{{ total }} entities match filters.</p>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Entity ID</th>
            <th>Name</th>
            <th>Domain</th>
            <th>State</th>
            <th>Area</th>
            <th>Location</th>
            <th>Last Updated</th>
            <th>Pulled At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for entity in entities %}
          <tr>
            <td><code>{{ entity.entity_id }}</code></td>
            <td>{{ entity.friendly_name or '' }}</td>
            <td>{{ entity.domain }}</td>
            <td>{{ entity.state }}</td>
            <td>{{ entity.area_name or '' }}</td>
            <td>{{ entity.location_name or '' }}</td>
            <td>{{ entity.last_updated or '' }}</td>
            <td>{{ entity.pulled_at }}</td>
            <td>
              <a href="/entities/{{ entity.entity_id }}?{{ build_query(profile_id=active_profile.id, sync_run_id=active_sync_run.id) }}">Details</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="row between">
      <div>Page {{ page }} of {{ total_pages }}</div>
      <div class="row gap-sm">
        {% if page > 1 %}
          <a class="button" href="/entities?{{ build_query(profile_id=active_profile.id, sync_run_id=active_sync_run.id, q=q, domain=domain, state=state_value, changed_within=changed_within, page=page-1, page_size=page_size) }}">Previous</a>
        {% endif %}
        {% if page < total_pages %}
          <a class="button" href="/entities?{{ build_query(profile_id=active_profile.id, sync_run_id=active_sync_run.id, q=q, domain=domain, state=state_value, changed_within=changed_within, page=page+1, page_size=page_size) }}">Next</a>
        {% endif %}
      </div>
    </div>
  {% elif active_profile %}
    <p>No synced entities for this profile yet. Use <strong>Sync Now</strong>.</p>
  {% elif profile_count > 0 %}
    <p>No enabled profiles are available. Enable a profile on the <a href="/settings">Profiles page</a>.</p>
  {% else %}
    <p>No profiles are configured yet. Add one on the <a href="/settings">Profiles page</a>.</p>
    <p>
      Need help? See
      <a href="https://www.home-assistant.io/docs/configuration/" target="_blank" rel="noreferrer">Home Assistant configuration</a>
      and
      <a href="https://developers.home-assistant.io/docs/auth_api/#long-lived-access-token" target="_blank" rel="noreferrer">token setup</a>.
    </p>
  {% endif %}
</section>
{% endblock %}
